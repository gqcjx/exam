# 批量导入学生名单功能实施总结

## ✅ 已完成的功能

### 1. 数据库迁移

**文件**：`supabase/migrations/create_import_history_table.sql`

**内容**：
- ✅ 创建 `import_history` 表
- ✅ 创建索引（user_id, import_type, created_at）
- ✅ 启用 RLS 并配置安全策略
- ✅ 支持用户查看自己的导入历史，管理员查看所有导入历史

### 2. 权限控制优化

**文件**：`src/api/batchImport.ts`

**功能**：
- ✅ 管理员：可以导入所有学校的学生
- ✅ 指定班主任：只能导入自己管理的班级的学生
- ✅ 普通教师：无导入权限（需要先配置管理的班级）

**实现逻辑**：
```typescript
// 检查是否为班主任（教师必须有管理的班级才能导入）
if (currentUserRole === 'teacher') {
  if (!currentUserClassIds || currentUserClassIds.length === 0) {
    throw new Error('只有班主任可以批量导入学生，请先配置管理的班级')
  }
}
```

### 3. Excel 文件支持

**文件**：`src/api/batchImport.ts`

**功能**：
- ✅ 支持 `.xlsx` 和 `.xls` 格式
- ✅ 自动识别表头（支持中英文列名）
- ✅ 解析学生数据（姓名、昵称、邮箱、手机号、学校、年级、班级、密码）

**支持的列名**：
- 姓名/Name（必填）
- 昵称/Nickname（可选）
- 邮箱/Email（可选）
- 手机号/Phone（可选）
- 学校/School（可选）
- 年级/Grade（可选）
- 班级/Class（可选）
- 密码/Password（可选）

### 4. 同班同名处理

**文件**：`src/api/batchImport.ts`

**功能**：
- ✅ 同班同名自动添加后缀
- ✅ 第一个为"张三"，第二个为"张三A"，第三个为"张三AA"，依此类推
- ✅ 同时考虑数据库中已存在的和本次导入批次中的同名

**实现逻辑**：
```typescript
// 处理同名学生：在同班同名的情况下，添加后缀（A, AA, AAA...）
async function handleDuplicateName(
  name: string,
  class_id: string | null,
  currentBatchNames: Map<string, Set<string>>, // 本次导入批次中已使用的姓名
): Promise<string>
```

### 5. 已存在学生跳过

**文件**：`src/api/batchImport.ts`

**功能**：
- ✅ 通过邮箱或手机号判断学生是否已存在
- ✅ 如果已存在，自动跳过并记录错误信息
- ✅ 不会创建重复账号

**实现逻辑**：
```typescript
// 检查学生是否已存在（通过邮箱或手机号）
const exists = await checkStudentExists(student.email, student.phone)
if (exists) {
  failed++
  errors.push(`${student.name}: 学生已存在（邮箱或手机号重复），已跳过`)
  continue
}
```

### 6. 导入数量限制

**文件**：`src/api/batchImport.ts`, `src/pages/AdminImportStudents.tsx`

**功能**：
- ✅ 单次导入上限：6000 条
- ✅ 导入前验证文件数据量
- ✅ 超过上限时提示错误

### 7. 导入历史记录

**文件**：`src/api/batchImport.ts`

**功能**：
- ✅ 记录每次导入操作
- ✅ 保存文件名、总数、成功数、失败数、错误信息
- ✅ 支持查询导入历史记录

**API 函数**：
- `getImportHistory(limit: number)`: 获取导入历史记录

### 8. 导入模板下载

**文件**：`src/api/batchImport.ts`

**功能**：
- ✅ 生成 Excel 模板文件
- ✅ 包含示例数据和格式说明
- ✅ 自动设置列宽

**函数**：
- `generateImportTemplate()`: 生成并下载模板文件

### 9. 导入页面优化

**文件**：`src/pages/AdminImportStudents.tsx`

**功能**：
- ✅ 文件选择（支持 .xlsx, .xls）
- ✅ 文件大小验证（限制 100MB）
- ✅ 数据预览（显示前 20 条）
- ✅ 默认学校/年级/班级设置
- ✅ 默认密码设置
- ✅ 导入进度显示
- ✅ 导入结果展示（成功/失败数量、错误详情）
- ✅ 导入历史记录显示
- ✅ 模板下载按钮
- ✅ 详细的格式说明

### 10. 用户管理页面更新

**文件**：`src/pages/AdminUsers.tsx`

**功能**：
- ✅ 更新为支持 Excel 格式
- ✅ 添加文件大小和数量验证
- ✅ 更新导入逻辑以匹配新的 API

## 📋 数据库变更

### 新增表：import_history

```sql
CREATE TABLE IF NOT EXISTS public.import_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.profiles(user_id) ON DELETE CASCADE,
  import_type VARCHAR(50) NOT NULL DEFAULT 'students',
  file_name VARCHAR(255) NOT NULL,
  total_count INTEGER NOT NULL DEFAULT 0,
  success_count INTEGER NOT NULL DEFAULT 0,
  failed_count INTEGER NOT NULL DEFAULT 0,
  errors TEXT[] DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

## 🎯 使用说明

### 管理员导入

1. 访问 `/admin/import-students` 页面
2. 点击"下载模板"按钮，下载 Excel 模板
3. 填写学生信息（姓名必填，其他可选）
4. 选择 Excel 文件并上传
5. 系统自动解析并预览数据
6. 可选择默认学校/年级/班级（应用到所有学生）
7. 设置默认密码（如果 Excel 中未指定）
8. 点击"开始导入"按钮
9. 查看导入结果和历史记录

### 班主任导入

1. 访问 `/admin/import-students` 页面
2. 只能导入自己管理的班级的学生
3. 其他步骤与管理员相同

### Excel 文件格式

| 姓名 | 昵称 | 邮箱 | 手机号 | 学校 | 年级 | 班级 | 密码 |
|------|------|------|--------|------|------|------|------|
| 张三 | 小张 | zhangsan@example.com | 13800138000 | 第一中学 | 高一 | 1班 | 123456 |
| 李四 | 小李 | lisi@example.com | 13900139000 | 第一中学 | 高一 | 2班 | 123456 |

**注意事项**：
- 姓名列是必填的
- 昵称、邮箱、手机号为可选
- 学校、年级、班级名称需要与系统中配置的完全匹配
- 如果 Excel 中未指定学校/年级/班级，可以在页面上设置默认值
- 如果 Excel 中未指定密码，将使用页面设置的默认密码

### 同名处理规则

- 同班同名时，第一个为"张三"，第二个为"张三A"，第三个为"张三AA"，依此类推
- 系统会自动处理，无需手动添加后缀

### 已存在学生处理

- 通过邮箱或手机号判断学生是否已存在
- 如果已存在，自动跳过，不会创建重复账号
- 错误信息中会记录跳过的学生

## 🔒 安全考虑

### 1. 权限控制
- ✅ 只有管理员和指定班主任可以导入
- ✅ 班主任只能导入自己管理的班级的学生
- ✅ 普通教师无导入权限

### 2. 数据验证
- ✅ 文件大小限制（100MB）
- ✅ 导入数量限制（6000 条）
- ✅ 文件格式验证（只支持 Excel）
- ✅ 必填字段验证（姓名）

### 3. 错误处理
- ✅ 详细的错误信息记录
- ✅ 部分成功支持（继续导入其他学生）
- ✅ 导入历史记录（可追溯）

## 📝 技术实现

### 依赖库

```json
{
  "xlsx": "^0.18.5"  // Excel 文件解析
}
```

### 主要函数

1. **parseExcelFile(file: File)**: 解析 Excel 文件
2. **batchImportStudents(...)**: 批量导入学生
3. **handleDuplicateName(...)**: 处理同班同名
4. **checkStudentExists(...)**: 检查学生是否已存在
5. **generateImportTemplate()**: 生成导入模板
6. **getImportHistory(limit)**: 获取导入历史

### 导入流程

1. 用户选择 Excel 文件
2. 系统解析文件并验证格式
3. 检查导入数量上限（6000）
4. 创建导入历史记录
5. 遍历每个学生：
   - 解析学校/年级/班级
   - 权限检查（班主任只能导入自己班级）
   - 检查是否已存在（跳过）
   - 处理同名（添加后缀）
   - 创建用户账号和档案
6. 更新导入历史记录
7. 返回导入结果

## 🚀 后续优化建议

1. **导入进度实时更新**：当前进度显示是静态的，可以优化为实时更新
2. **批量更新功能**：支持更新已存在学生的信息
3. **错误报告导出**：支持导出错误报告为 Excel
4. **导入历史详情**：点击历史记录查看详细错误信息
5. **数据验证增强**：导入前完整验证所有数据

## ✅ 测试建议

1. **权限测试**：
   - 管理员导入所有学校的学生
   - 班主任导入自己班级的学生
   - 普通教师尝试导入（应该被拒绝）

2. **同名处理测试**：
   - 导入同班同名的学生
   - 验证后缀是否正确添加（A, AA, AAA...）

3. **已存在学生测试**：
   - 导入已存在的学生（通过邮箱或手机号）
   - 验证是否正确跳过

4. **数量限制测试**：
   - 导入超过 6000 条的数据
   - 验证是否正确提示错误

5. **文件格式测试**：
   - 测试 .xlsx 和 .xls 格式
   - 测试错误的文件格式（应该被拒绝）

## 📌 注意事项

1. **数据库迁移**：需要手动执行 `create_import_history_table.sql` 迁移文件
2. **权限配置**：确保班主任已配置管理的班级（通过 `teacher_class_relations` 表）
3. **学校/年级/班级配置**：确保系统中已配置相应的学校、年级、班级数据
4. **默认密码**：建议首次登录后修改密码
