# 大嘴鸟游戏积分系统集成说明

## 📋 功能概述

已成功将 `dazui` 子目录中的大嘴鸟游戏与学生账户系统集成，实现了以下功能：

1. ✅ **游戏积分自动保存**：游戏结束时自动保存积分到数据库
2. ✅ **游戏排行榜**：显示所有学生的游戏成绩排名
3. ✅ **权限控制**：仅学生可以玩游戏，所有人可以查看排行榜
4. ✅ **Dashboard 集成**：在首页添加游戏入口和排行榜链接

## 🗄️ 数据库设计

### game_scores 表

已创建 `game_scores` 表，包含以下字段：

- `id`: UUID 主键
- `user_id`: 用户ID（外键关联 auth.users）
- `game_name`: 游戏名称（默认 'dazui'）
- `score`: 最终分数
- `level`: 达到的等级
- `correct_count`: 正确数
- `wrong_count`: 错误数
- `play_duration`: 游戏时长（秒）
- `best_score`: 历史最高分
- `created_at`: 创建时间
- `updated_at`: 更新时间

### RLS 策略

- **学生**：可以查看、插入、更新自己的积分
- **教师/管理员**：可以查看所有学生的积分（用于排行榜）

## 🔐 认证方式

采用**方案B：URL 参数传递 token**

### 工作流程

1. 学生从 Dashboard 点击"开始游戏"
2. `GameDazui` 页面获取当前 session 的 access token
3. 将 token、Supabase URL 和 anon key 通过 URL 参数传递给游戏页面
4. 游戏页面初始化 Supabase 客户端，使用 token 进行认证
5. 游戏结束时自动保存积分

### URL 格式

```
/dazui/index.html?token=<access_token>&supabase_url=<supabase_url>&supabase_key=<anon_key>
```

## 💾 数据同步

采用**游戏结束时保存**策略：

- 游戏开始时记录开始时间
- 游戏结束时（点击"重置"按钮）自动保存积分
- 如果当前分数高于历史最高分，自动更新 `best_score`

## 📁 文件结构

### 新增文件

```
supabase/migrations/create_game_scores_table.sql  # 数据库迁移文件
src/api/game.ts                                    # 游戏积分 API
src/pages/GameDazui.tsx                           # 游戏入口页面
src/pages/GameRanking.tsx                         # 排行榜页面
public/dazui/                                      # 游戏文件（复制到 public 目录）
```

### 修改文件

```
dazui/app.js              # 添加 Supabase 集成和积分保存功能
src/routes.tsx            # 添加游戏路由
src/pages/Dashboard.tsx   # 添加游戏入口卡片
```

## 🎮 使用方法

### 学生端

1. **开始游戏**：
   - 登录后进入 Dashboard
   - 点击"大嘴鸟游戏"卡片
   - 自动跳转到游戏页面并开始游戏

2. **查看排行榜**：
   - 在 Dashboard 点击"游戏排行榜"卡片
   - 或直接访问 `/game/ranking`

3. **保存积分**：
   - 游戏结束后点击"重置"按钮
   - 积分会自动保存到数据库
   - 如果分数更高，会自动更新最高分

### 教师/管理员端

1. **查看排行榜**：
   - 登录后访问 `/game/ranking`
   - 可以查看所有学生的游戏成绩

## 🔧 技术实现细节

### 游戏代码集成

在 `dazui/app.js` 中添加了以下功能：

1. **Supabase 初始化**：
   ```javascript
   async function initSupabase() {
     // 从 URL 参数获取 token 和配置
     // 初始化 Supabase 客户端
   }
   ```

2. **积分保存**：
   ```javascript
   async function saveGameScore() {
     // 计算游戏时长
     // 使用 upsert 保存或更新积分
     // 更新历史最高分
   }
   ```

3. **游戏生命周期**：
   - `startGame()`: 记录游戏开始时间
   - `resetGame()`: 游戏结束时保存积分

### API 函数

`src/api/game.ts` 提供了以下 API：

- `getMyGameScore()`: 获取当前用户的游戏积分
- `getGameRanking()`: 获取游戏排行榜

### 路由配置

- `/game/dazui`: 游戏入口（仅学生）
- `/game/ranking`: 排行榜（所有已登录用户）

## ⚠️ 注意事项

1. **游戏文件位置**：
   - 游戏文件需要放在 `public/dazui/` 目录下
   - 已自动复制到 public 目录

2. **认证 Token**：
   - Token 通过 URL 参数传递，注意安全性
   - Token 有时效性，过期后需要重新登录

3. **离线模式**：
   - 如果未提供认证信息，游戏会以离线模式运行
   - 离线模式下积分不会保存

4. **数据一致性**：
   - 每个用户每个游戏只保留一条记录（最新记录）
   - 使用 `upsert` 确保数据一致性

## 🚀 后续优化建议

1. **实时保存**：可以添加定时保存功能（如每30秒保存一次）
2. **历史记录**：改为保留每次游戏记录，而非只保留最新记录
3. **成就系统**：添加游戏成就和徽章
4. **班级/年级排行榜**：按班级或年级显示排行榜
5. **游戏统计**：添加游戏时长、游戏次数等统计信息

## 📝 测试建议

1. **功能测试**：
   - 学生登录后能否正常进入游戏
   - 游戏结束后积分是否正确保存
   - 排行榜是否正确显示

2. **权限测试**：
   - 学生能否玩游戏
   - 非学生能否查看排行榜
   - 未登录用户是否被重定向

3. **数据测试**：
   - 多次游戏后最高分是否正确更新
   - 游戏时长是否正确计算
   - 排行榜排序是否正确

## ✅ 完成状态

- [x] 数据库表创建
- [x] 游戏代码集成
- [x] 游戏入口页面
- [x] 排行榜页面
- [x] Dashboard 集成
- [x] 路由配置
- [x] 权限控制
- [x] 代码提交

## 🎯 使用示例

### 学生玩游戏流程

1. 学生登录系统
2. 在 Dashboard 看到"大嘴鸟游戏"卡片
3. 点击"开始游戏"
4. 自动跳转到游戏页面
5. 开始游戏，获得分数
6. 游戏结束后点击"重置"
7. 积分自动保存
8. 可以查看排行榜查看自己的排名

### 查看排行榜流程

1. 登录系统（任何角色）
2. 在 Dashboard 点击"游戏排行榜"
3. 或直接访问 `/game/ranking`
4. 查看所有学生的游戏成绩排名
5. 前三名有特殊展示（奖杯图标）
6. 自己的排名会高亮显示

---

**集成完成！现在学生可以在学习之余通过游戏放松，同时积分会自动保存并显示在排行榜上。** 🎮🏆
