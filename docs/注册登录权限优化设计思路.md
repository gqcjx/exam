# 注册登录权限优化设计思路

## 📋 当前问题分析

### 1. 注册流程问题
- ❌ **所有用户都固定注册为学生角色**，无法选择其他角色
- ❌ **没有角色选择界面**，用户无法知道自己注册的是什么角色
- ❌ **教师和管理员无法通过注册获得**，只能通过管理员后台创建
- ❌ **家长注册后需要手动绑定孩子**，流程不够清晰

### 2. 登录流程问题
- ⚠️ **登录后没有根据角色进行差异化引导**
- ⚠️ **没有角色切换或提示功能**
- ⚠️ **账号状态提示不够明确**（如：等待审核、已禁用等）

### 3. 权限控制问题
- ✅ **路由权限控制已实现**（通过 `ProtectedRoute`）
- ⚠️ **但注册时无法选择角色，导致权限分配不合理**

## 🎯 优化目标

### 核心原则
1. **安全性**：管理员和教师不能公开注册，需要审核或邀请
2. **易用性**：学生和家长可以自由注册，流程简单
3. **清晰性**：用户明确知道自己的角色和权限
4. **灵活性**：支持后续角色调整和权限管理

## 📐 设计方案

### 方案一：分角色注册流程（推荐）

#### 1.1 注册页面优化

**设计思路**：
- 将注册页面分为两个步骤：
  1. **选择注册类型**（学生/家长）
  2. **填写注册信息**

**界面设计**：
```
┌─────────────────────────────────┐
│  选择注册类型                    │
├─────────────────────────────────┤
│  ○ 学生注册                     │
│     - 参加考试                   │
│     - 查看成绩                   │
│     - 错题本                     │
│                                 │
│  ○ 家长注册                     │
│     - 查看孩子成绩               │
│     - 绑定多个孩子               │
│     - 成绩报表                   │
│                                 │
│  [下一步]                        │
└─────────────────────────────────┘
```

**实现要点**：
- 学生和家长可以公开注册
- 教师和管理员不显示在注册选项中
- 注册后自动分配对应角色

#### 1.2 教师/管理员注册流程

**设计思路**：
- **教师**：需要邀请码或管理员审核
- **管理员**：只能由现有管理员在后台创建

**实现方案**：

**方案 A：邀请码机制（推荐）**
```
教师注册流程：
1. 管理员生成邀请码（在后台管理）
2. 教师使用邀请码注册
3. 注册时输入邀请码，自动分配教师角色
4. 邀请码使用后失效或设置有效期
```

**方案 B：审核机制**
```
教师注册流程：
1. 用户先注册为学生角色
2. 在个人设置中申请成为教师
3. 管理员审核通过后，角色升级为教师
```

**推荐方案 A**，因为：
- 更安全，避免未授权用户申请
- 更高效，无需审核流程
- 更清晰，教师明确知道自己的权限

#### 1.3 家长注册优化

**设计思路**：
- 注册时可以选择是否立即绑定孩子
- 如果选择绑定，需要输入孩子的邮箱
- 如果暂不绑定，注册后可以在家长端绑定

**界面流程**：
```
注册信息填写
├─ 姓名
├─ 邮箱
├─ 密码
└─ 是否立即绑定孩子？
   ├─ 是 → 输入孩子邮箱
   └─ 否 → 注册后可在家长端绑定
```

### 方案二：登录页面优化

#### 2.1 角色提示

**设计思路**：
- 登录成功后，根据角色显示不同的欢迎信息
- 提示用户当前的角色和主要功能

**实现示例**：
```typescript
// 学生登录后
"欢迎回来，张三（学生）！"
"您有 3 场考试待完成"

// 教师登录后
"欢迎回来，李老师！"
"您有 5 份试卷待批阅"

// 家长登录后
"欢迎回来，王家长！"
"您已绑定 2 个孩子"
```

#### 2.2 账号状态提示

**设计思路**：
- 如果账号被禁用，显示明确的提示
- 如果账号等待审核，显示审核状态
- 如果角色未分配，提示联系管理员

**实现要点**：
- 在 `ProtectedRoute` 中已实现禁用检查
- 可以增加"等待审核"状态
- 可以增加"角色未分配"状态

### 方案三：权限管理优化

#### 3.1 角色权限矩阵

| 功能 | 学生 | 家长 | 教师 | 管理员 |
|------|------|------|------|--------|
| 参加考试 | ✅ | ❌ | ❌ | ❌ |
| 查看成绩 | ✅ | ✅（孩子） | ✅ | ✅ |
| 错题本 | ✅ | ❌ | ❌ | ❌ |
| 题库管理 | ❌ | ❌ | ✅ | ✅ |
| 试卷管理 | ❌ | ❌ | ✅ | ✅ |
| 批阅试卷 | ❌ | ❌ | ✅ | ✅ |
| 用户管理 | ❌ | ❌ | ❌ | ✅ |
| 系统配置 | ❌ | ❌ | ✅ | ✅ |

#### 3.2 权限检查优化

**当前实现**：
- ✅ 路由级权限控制（`ProtectedRoute`）
- ⚠️ 功能级权限控制需要加强

**优化建议**：
- 在关键操作前再次检查权限
- 提供更友好的权限不足提示
- 记录权限检查日志（可选）

## 🔧 技术实现方案

### 1. 注册页面重构

**文件**：`src/pages/Register.tsx`

**主要改动**：
1. 添加角色选择步骤
2. 根据选择的角色显示不同的表单
3. 家长注册时添加绑定孩子选项
4. 教师注册时添加邀请码输入

**代码结构**：
```typescript
// 步骤 1：选择注册类型
const [step, setStep] = useState<'select' | 'form'>('select')
const [registerType, setRegisterType] = useState<'student' | 'parent' | null>(null)

// 步骤 2：填写注册信息
const [formData, setFormData] = useState({
  name: '',
  email: '',
  password: '',
  childEmail: '', // 仅家长注册时使用
  inviteCode: '', // 仅教师注册时使用
})
```

### 2. 邀请码系统

**数据库设计**：
```sql
-- 邀请码表
CREATE TABLE invite_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code VARCHAR(50) UNIQUE NOT NULL,
  role VARCHAR(20) NOT NULL, -- 'teacher' or 'admin'
  created_by UUID REFERENCES profiles(user_id),
  used_by UUID REFERENCES profiles(user_id),
  used_at TIMESTAMP,
  expires_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);
```

**功能实现**：
- 管理员可以生成邀请码
- 邀请码可以设置有效期
- 邀请码使用后标记为已使用
- 教师注册时验证邀请码

### 3. 登录页面优化

**文件**：`src/pages/Login.tsx`

**主要改动**：
1. 登录成功后根据角色显示欢迎信息
2. 添加账号状态检查
3. 优化错误提示

### 4. 权限管理增强

**文件**：`src/components/ProtectedRoute.tsx`

**主要改动**：
1. 增加"等待审核"状态检查
2. 增加"角色未分配"状态检查
3. 优化权限不足提示

## 📊 实施优先级

### P0（必须实现）
1. ✅ **注册页面角色选择**
   - 学生和家长可以选择注册类型
   - 教师和管理员不显示在注册选项

2. ✅ **家长注册绑定优化**
   - 注册时可以选择是否绑定孩子
   - 注册后可以在家长端绑定

### P1（重要功能）
3. ⚠️ **教师邀请码系统**
   - 管理员可以生成邀请码
   - 教师使用邀请码注册
   - 邀请码管理界面

4. ⚠️ **登录页面优化**
   - 角色提示
   - 账号状态提示
   - 欢迎信息

### P2（增强功能）
5. 🔄 **权限管理增强**
   - 功能级权限检查
   - 权限不足提示优化
   - 权限日志记录

## 🎨 UI/UX 设计建议

### 注册页面
- **步骤指示器**：显示当前步骤（1/2, 2/2）
- **角色卡片**：使用卡片式设计展示不同角色
- **表单验证**：实时验证邮箱格式、密码强度
- **帮助提示**：每个角色下方显示功能说明

### 登录页面
- **角色标识**：登录后显示角色徽章
- **快捷入口**：根据角色显示常用功能入口
- **状态提示**：清晰的账号状态提示

## 🔒 安全考虑

### 1. 角色分配安全
- ✅ 学生和家长可以自由注册，但角色固定
- ✅ 教师需要邀请码，防止未授权注册
- ✅ 管理员只能由现有管理员创建

### 2. 邀请码安全
- 邀请码应该足够复杂（至少 8 位）
- 邀请码应该设置有效期
- 邀请码使用后应该失效
- 记录邀请码使用日志

### 3. 权限检查
- 前端权限检查（用户体验）
- 后端权限检查（安全性）
- 数据库 RLS 策略（最后防线）

## 📝 数据库变更

### 新增表：invite_codes
```sql
CREATE TABLE invite_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code VARCHAR(50) UNIQUE NOT NULL,
  role VARCHAR(20) NOT NULL CHECK (role IN ('teacher', 'admin')),
  created_by UUID REFERENCES profiles(user_id),
  used_by UUID REFERENCES profiles(user_id),
  used_at TIMESTAMP,
  expires_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_invite_codes_code ON invite_codes(code);
CREATE INDEX idx_invite_codes_role ON invite_codes(role);
```

### 可选：profiles 表增加状态字段
```sql
-- 如果需要审核机制
ALTER TABLE profiles ADD COLUMN status VARCHAR(20) DEFAULT 'active' 
  CHECK (status IN ('active', 'pending', 'disabled'));
```

## 🚀 实施步骤

### 第一阶段：注册页面优化
1. 重构 `Register.tsx`，添加角色选择
2. 实现学生和家长注册流程
3. 实现家长绑定孩子功能
4. 测试注册流程

### 第二阶段：邀请码系统
1. 创建 `invite_codes` 表
2. 实现邀请码生成功能（管理员后台）
3. 实现邀请码验证功能（注册页面）
4. 实现邀请码管理界面

### 第三阶段：登录优化
1. 优化登录页面，添加角色提示
2. 优化账号状态检查
3. 添加欢迎信息

### 第四阶段：权限增强
1. 增强权限检查逻辑
2. 优化权限不足提示
3. 添加权限日志（可选）

## ❓ 待确认问题

1. **教师注册方式**：
   - 选择 A：邀请码机制（推荐）
   - 选择 B：审核机制
   - 选择 C：其他方式

2. **家长绑定时机**：
   - 选择 A：注册时立即绑定（推荐）
   - 选择 B：注册后手动绑定
   - 选择 C：两种方式都支持

3. **账号状态管理**：
   - 是否需要"等待审核"状态？
   - 是否需要"角色未分配"状态？

4. **邀请码有效期**：
   - 默认有效期多长？（建议 7-30 天）
   - 是否允许永久有效？

---

**请查看以上设计思路，确认是否符合您的需求。确认后我将开始实施！**

