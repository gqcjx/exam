# æ•°æ®åº“å®‰å…¨æ€§ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ ä¿®å¤æ¦‚è¿°

æœ¬æ¬¡ä¿®å¤é’ˆå¯¹ Supabase æ•°æ®åº“çš„å®‰å…¨æ€§é—®é¢˜è¿›è¡Œäº†å…¨é¢ä¿®å¤ï¼ŒåŒ…æ‹¬ï¼š
1. ä¸ºæœªå¯ç”¨ RLS çš„è¡¨æ·»åŠ äº† RLS ç­–ç•¥
2. ä¿®å¤äº†å‡½æ•°çš„ search_path å®‰å…¨æ€§é—®é¢˜
3. ä¼˜åŒ–äº†ç°æœ‰ RLS ç­–ç•¥çš„æ€§èƒ½

---

## âœ… ä¿®å¤å†…å®¹

### 1. RLS ç­–ç•¥ä¿®å¤

#### å·²å¯ç”¨ RLS çš„è¡¨ï¼ˆ4ä¸ªï¼‰

| è¡¨å | çŠ¶æ€ | ç­–ç•¥æ•°é‡ |
|------|------|----------|
| `paper_questions` | âœ… å·²å¯ç”¨ | 4ä¸ªç­–ç•¥ |
| `answers_draft` | âœ… å·²å¯ç”¨ | 4ä¸ªç­–ç•¥ |
| `wrong_questions` | âœ… å·²å¯ç”¨ | 5ä¸ªç­–ç•¥ |
| `tags` | âœ… å·²å¯ç”¨ | 4ä¸ªç­–ç•¥ |

#### RLS ç­–ç•¥è¯¦æƒ…

**paper_questions è¡¨**
- âœ… `paper_questions read all` - æ‰€æœ‰äººå¯æŸ¥çœ‹
- âœ… `paper_questions insert admin/teacher` - ä»…ç®¡ç†å‘˜/æ•™å¸ˆå¯æ’å…¥
- âœ… `paper_questions update admin/teacher` - ä»…ç®¡ç†å‘˜/æ•™å¸ˆå¯æ›´æ–°
- âœ… `paper_questions delete admin/teacher` - ä»…ç®¡ç†å‘˜/æ•™å¸ˆå¯åˆ é™¤

**answers_draft è¡¨**
- âœ… `answers_draft owner select` - ä»…æ‰€æœ‰è€…å¯æŸ¥çœ‹
- âœ… `answers_draft owner insert` - ä»…æ‰€æœ‰è€…å¯æ’å…¥
- âœ… `answers_draft owner update` - ä»…æ‰€æœ‰è€…å¯æ›´æ–°
- âœ… `answers_draft owner delete` - ä»…æ‰€æœ‰è€…å¯åˆ é™¤

**wrong_questions è¡¨**
- âœ… `wrong_questions owner select` - ä»…æ‰€æœ‰è€…å¯æŸ¥çœ‹
- âœ… `wrong_questions owner insert` - ä»…æ‰€æœ‰è€…å¯æ’å…¥
- âœ… `wrong_questions owner update` - ä»…æ‰€æœ‰è€…å¯æ›´æ–°
- âœ… `wrong_questions owner delete` - ä»…æ‰€æœ‰è€…å¯åˆ é™¤
- âœ… `wrong_questions teacher/admin read` - æ•™å¸ˆ/ç®¡ç†å‘˜å¯æŸ¥çœ‹æ‰€æœ‰ï¼ˆç”¨äºç»Ÿè®¡åˆ†æï¼‰

**tags è¡¨**
- âœ… `tags read all` - æ‰€æœ‰äººå¯æŸ¥çœ‹
- âœ… `tags insert admin/teacher` - ä»…ç®¡ç†å‘˜/æ•™å¸ˆå¯æ’å…¥
- âœ… `tags update admin/teacher` - ä»…ç®¡ç†å‘˜/æ•™å¸ˆå¯æ›´æ–°
- âœ… `tags delete admin/teacher` - ä»…ç®¡ç†å‘˜/æ•™å¸ˆå¯åˆ é™¤

---

### 2. å‡½æ•°å®‰å…¨æ€§ä¿®å¤

#### å·²ä¿®å¤çš„å‡½æ•°ï¼ˆ4ä¸ªï¼‰

| å‡½æ•°å | ä¿®å¤å†…å®¹ | çŠ¶æ€ |
|--------|----------|------|
| `fn_random_questions` | æ·»åŠ  `SET search_path = public` | âœ… å·²ä¿®å¤ |
| `sync_profile_email_on_create` | æ·»åŠ  `SET search_path = public` | âœ… å·²ä¿®å¤ |
| `sync_email_on_profile_create` | æ·»åŠ  `SET search_path = public` | âœ… å·²ä¿®å¤ |
| `sync_profile_email_on_update` | æ·»åŠ  `SET search_path = public` | âœ… å·²ä¿®å¤ |

#### ä¿®å¤è¯´æ˜

æ‰€æœ‰ `SECURITY DEFINER` å‡½æ•°éƒ½å·²è®¾ç½® `SET search_path = public`ï¼Œé˜²æ­¢ search_path æ³¨å…¥æ”»å‡»ã€‚

---

### 3. RLS ç­–ç•¥æ€§èƒ½ä¼˜åŒ–

#### ä¼˜åŒ–çš„ç­–ç•¥

ä»¥ä¸‹è¡¨çš„ RLS ç­–ç•¥å·²ä» `auth.uid()` ä¼˜åŒ–ä¸º `(SELECT auth.uid())`ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½ï¼š

- âœ… `profiles` è¡¨ï¼ˆ3ä¸ªç­–ç•¥ï¼‰
- âœ… `papers` è¡¨ï¼ˆ1ä¸ªç­–ç•¥ï¼‰
- âœ… `answers` è¡¨ï¼ˆ3ä¸ªç­–ç•¥ï¼‰
- âœ… `parent_child` è¡¨ï¼ˆ2ä¸ªç­–ç•¥ï¼‰
- âœ… `notifications` è¡¨ï¼ˆ3ä¸ªç­–ç•¥ï¼‰
- âœ… `answers_draft` è¡¨ï¼ˆ4ä¸ªç­–ç•¥ï¼‰
- âœ… `wrong_questions` è¡¨ï¼ˆ4ä¸ªç­–ç•¥ï¼‰

#### æ€§èƒ½æå‡

ä½¿ç”¨ `(SELECT auth.uid())` æ›¿ä»£ `auth.uid()` å¯ä»¥ï¼š
- é¿å…åœ¨æ¯è¡Œè¯„ä¼°æ—¶é‡æ–°è®¡ç®— `auth.uid()`
- æå‡ RLS ç­–ç•¥çš„æ‰§è¡Œæ•ˆç‡
- å‡å°‘æ•°æ®åº“è´Ÿè½½

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰

**å®‰å…¨æ€§é—®é¢˜ï¼š**
- âŒ 4ä¸ªè¡¨æœªå¯ç”¨ RLS
- âŒ 4ä¸ªå‡½æ•°ç¼ºå°‘ search_path è®¾ç½®
- âš ï¸ å¤šä¸ª RLS ç­–ç•¥æ€§èƒ½ä¸ä½³

**Supabase Advisor æ£€æŸ¥ç»“æœï¼š**
- ERROR: 4ä¸ªè¡¨æœªå¯ç”¨ RLS
- WARN: 4ä¸ªå‡½æ•° search_path æœªè®¾ç½®
- WARN: å¤šä¸ª RLS ç­–ç•¥æ€§èƒ½é—®é¢˜

### ä¿®å¤å

**å®‰å…¨æ€§çŠ¶æ€ï¼š**
- âœ… æ‰€æœ‰å…¬å¼€è¡¨éƒ½å·²å¯ç”¨ RLS
- âœ… æ‰€æœ‰å‡½æ•°éƒ½å·²è®¾ç½® search_path
- âœ… RLS ç­–ç•¥æ€§èƒ½å·²ä¼˜åŒ–

**Supabase Advisor æ£€æŸ¥ç»“æœï¼š**
- âœ… æ—  ERROR çº§åˆ«é—®é¢˜
- âœ… æ— å‡½æ•°å®‰å…¨æ€§é—®é¢˜
- âš ï¸ ä»…å‰© 1 ä¸ª WARNï¼šAuth æ³„éœ²å¯†ç ä¿æŠ¤æœªå¯ç”¨ï¼ˆéœ€åœ¨ Dashboard æ‰‹åŠ¨é…ç½®ï¼‰

---

## ğŸ“ è¿ç§»æ–‡ä»¶

ä¿®å¤å·²é€šè¿‡æ•°æ®åº“è¿ç§»æ–‡ä»¶åº”ç”¨ï¼š
- æ–‡ä»¶è·¯å¾„ï¼š`supabase/migrations/fix_database_security.sql`
- è¿ç§»åç§°ï¼š`fix_database_security`
- çŠ¶æ€ï¼šâœ… å·²æˆåŠŸåº”ç”¨

---

## ğŸ” éªŒè¯ç»“æœ

### 1. RLS å¯ç”¨éªŒè¯

```sql
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public' 
  AND tablename IN ('paper_questions', 'answers_draft', 'wrong_questions', 'tags');
```

**ç»“æœï¼š** æ‰€æœ‰è¡¨ `rowsecurity = true` âœ…

### 2. å‡½æ•° search_path éªŒè¯

```sql
SELECT 
  p.proname as function_name,
  pg_get_functiondef(p.oid) LIKE '%SET search_path%' as has_search_path
FROM pg_proc p
JOIN pg_namespace n ON p.pronamespace = n.oid
WHERE n.nspname = 'public' 
  AND p.proname IN ('sync_profile_email_on_create', 'sync_email_on_profile_create', 'fn_random_questions', 'sync_profile_email_on_update');
```

**ç»“æœï¼š** æ‰€æœ‰å‡½æ•° `has_search_path = true` âœ…

### 3. Supabase Advisor æ£€æŸ¥

**å®‰å…¨æ€§æ£€æŸ¥ï¼š**
- âœ… æ—  ERROR çº§åˆ«é—®é¢˜
- âš ï¸ 1 ä¸ª WARNï¼šAuth æ³„éœ²å¯†ç ä¿æŠ¤æœªå¯ç”¨ï¼ˆéœ€æ‰‹åŠ¨é…ç½®ï¼‰

---

## âš ï¸ å‰©ä½™é—®é¢˜

### Auth æ³„éœ²å¯†ç ä¿æŠ¤

**é—®é¢˜ï¼š** Supabase Auth çš„æ³„éœ²å¯†ç ä¿æŠ¤åŠŸèƒ½æœªå¯ç”¨

**å½±å“ï¼š** ç”¨æˆ·å¯ä»¥ä½¿ç”¨å·²è¢«æ³„éœ²çš„å¯†ç ï¼ˆæ ¹æ® HaveIBeenPwned.org æ•°æ®åº“ï¼‰

**ä¿®å¤æ–¹æ³•ï¼š**
1. ç™»å½• Supabase Dashboard
2. è¿›å…¥ Authentication â†’ Settings
3. å¯ç”¨ "Leaked Password Protection"
4. é…ç½®ç›¸å…³é€‰é¡¹

**å‚è€ƒæ–‡æ¡£ï¼š** https://supabase.com/docs/guides/auth/password-security#password-strength-and-leaked-password-protection

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- è¿ç§»æ–‡ä»¶ï¼š`supabase/migrations/fix_database_security.sql`
- RLS ç­–ç•¥ï¼š`supabase/policies.sql`ï¼ˆå·²æ›´æ–°ï¼‰
- RPC å‡½æ•°ï¼š`supabase/rpc.sql`ï¼ˆå·²æ›´æ–°ï¼‰

---

## âœ… æ€»ç»“

æ•°æ®åº“å®‰å…¨æ€§ä¿®å¤å·²å®Œæˆï¼Œä¸»è¦æˆæœï¼š

1. âœ… **æ‰€æœ‰å…¬å¼€è¡¨éƒ½å·²å¯ç”¨ RLS** - é˜²æ­¢æœªæˆæƒè®¿é—®
2. âœ… **æ‰€æœ‰å‡½æ•°éƒ½å·²è®¾ç½® search_path** - é˜²æ­¢ search_path æ³¨å…¥æ”»å‡»
3. âœ… **RLS ç­–ç•¥æ€§èƒ½å·²ä¼˜åŒ–** - æå‡æŸ¥è¯¢æ•ˆç‡
4. âš ï¸ **å‰©ä½™ 1 ä¸ªé…ç½®é¡¹** - Auth æ³„éœ²å¯†ç ä¿æŠ¤éœ€åœ¨ Dashboard æ‰‹åŠ¨å¯ç”¨

**ä¿®å¤çŠ¶æ€ï¼š** âœ… å®Œæˆï¼ˆé™¤éœ€æ‰‹åŠ¨é…ç½®çš„ Auth è®¾ç½®å¤–ï¼‰


