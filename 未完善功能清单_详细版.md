# 未完善功能清单（详细版）

> 基于 Supabase 数据库检查和本地网站访问（http://localhost:5174/）生成

## 📊 数据库当前状态

- **题目数量**: 16 道
- **试卷数量**: 1 份
- **用户数量**: 3 个
- **学科**: 仅"语文"（硬编码）
- **年级**: 仅"七年级"（硬编码）

---

## 🔴 高优先级（P0）- 必须修复

### 1. **数据库安全性问题** ⚠️ 严重

#### 问题描述
根据 Supabase Advisor 检查，发现以下安全问题：

**RLS 未启用的表**（ERROR级别）：
- `paper_questions` - 试卷题目关联表
- `answers_draft` - 答案草稿表
- `wrong_questions` - 错题本表
- `tags` - 标签表

**函数安全性问题**（WARN级别）：
- `sync_profile_email_on_create` - search_path 未设置
- `sync_email_on_profile_create` - search_path 未设置
- `fn_random_questions` - search_path 未设置
- `sync_profile_email_on_update` - search_path 未设置

**其他安全问题**：
- 泄露密码保护未启用（Auth 配置）

#### 建议修复
1. 为所有公开表启用 RLS 策略
2. 修复函数 search_path 设置
3. 启用 Supabase Auth 的泄露密码保护

---

### 2. **学校与年级配置管理** ❌ 未实现

#### 问题描述
- 学科和年级硬编码在前端代码中（`QuestionForm.tsx`、`AdminPapers.tsx`）
- 数据库中只有"语文"和"七年级"的数据
- 缺少专门的配置管理界面
- 无法动态添加/编辑学校、年级、班级信息

#### 当前状态
- 前端硬编码选项：数学、语文、英语、物理、化学、科学
- 年级硬编码：七年级、八年级、九年级
- 数据库中没有配置表

#### 建议实现
1. 创建 `schools` 表（学校信息）
2. 创建 `grades` 表（年级信息）
3. 创建 `classes` 表（班级信息）
4. 创建管理员配置页面 `/admin/config`
5. 将前端硬编码改为从数据库读取

---

### 3. **数据库性能优化** ⚠️ 需要优化

#### 问题描述
根据 Supabase Advisor 检查，发现以下性能问题：

**缺少索引的外键**（INFO级别）：
- `answers.paper_id`
- `answers.question_id`
- `answers_draft.paper_id`
- `paper_questions.question_id`
- `papers.created_by`
- `parent_child.child_id`
- `questions.created_by`
- `wrong_questions.paper_id`

**RLS 策略性能问题**（WARN级别）：
- 多个表的 RLS 策略使用了 `auth.uid()` 而不是 `(select auth.uid())`，导致每行都重新计算
- 影响表：`profiles`、`papers`、`answers`、`parent_child`、`notifications`

**未使用的索引**（INFO级别）：
- `idx_questions_tags`
- `idx_answers_status`
- `idx_profiles_student_duplicate`
- `idx_profiles_teacher_duplicate`
- `idx_profiles_name`
- `idx_profiles_school`
- `idx_profiles_role`
- `idx_wrong_questions_user`
- `idx_wrong_questions_question`
- `idx_wrong_questions_mastered`
- `idx_wrong_questions_created`
- `idx_papers_parent`
- `idx_papers_version`
- `idx_notifications_user_id`
- `idx_notifications_created_at`

**多个宽松策略**（WARN级别）：
- `answers` 表有多个宽松策略，影响性能
- `profiles` 表有多个宽松策略，影响性能

#### 建议修复
1. 为所有外键添加索引
2. 优化 RLS 策略，使用 `(select auth.uid())` 替代 `auth.uid()`
3. 合并多个宽松策略为单个策略
4. 评估未使用索引，考虑删除或优化查询

---

## 🟡 中优先级（P1）- 重要功能

### 4. **试卷时间限制 UI 优化** ⚠️ 部分实现

#### 当前状态
- ✅ 数据库字段已添加（`start_time`、`end_time`）
- ✅ 创建试卷时有时间设置 UI（`AdminPapers.tsx` 第 572-589 行）
- ✅ 考试页面有时间校验逻辑（`Exam.tsx` 第 29-49 行）
- ⚠️ Dashboard 中时间限制信息显示不够明显

#### 建议优化
1. 在 Dashboard 中更清晰地显示考试开始/结束时间
2. 添加倒计时提醒（考试开始前）
3. 添加考试即将结束的警告提示

---

### 5. **移动端适配与 Capacitor 打包** ⚠️ 部分实现

#### 当前状态
- ✅ 有基础响应式设计（Tailwind CSS）
- ❌ 未找到 `capacitor.config.*` 文件
- ❌ Capacitor 打包可能未完成

#### 建议实现
1. 创建 `capacitor.config.ts` 配置文件
2. 完成 Android 打包配置
3. 优化移动端交互体验
4. 测试移动端功能

---

### 6. **数据备份功能** ❌ 未实现

#### 问题描述
- 无数据备份相关代码
- 无备份/恢复功能
- 无定期备份机制

#### 建议实现
1. 实现数据库备份功能（Supabase 自动备份或手动导出）
2. 支持导出备份文件（SQL 格式）
3. 支持恢复备份功能
4. 添加备份历史记录

---

## 🟢 低优先级（P2）- 增强功能

### 7. **试卷模板功能** ❌ 未实现

#### 描述
- 保存常用试卷模板
- 快速从模板创建试卷
- 模板分享功能

---

### 8. **题目难度自动评估** ⚠️ 部分实现

#### 当前状态
- ✅ 有 `difficulty` 字段（1-5）
- ❌ 无根据答题正确率自动调整难度的逻辑

#### 建议实现
1. 实现难度自动评估算法
2. 根据答题统计自动更新题目难度
3. 添加难度分布统计

---

### 9. **学习路径推荐** ❌ 未实现

#### 描述
- 根据错题推荐相关练习
- 根据成绩推荐学习内容
- 个性化学习建议

---

### 10. **批量操作优化** ⚠️ 部分实现

#### 当前状态
- ✅ 已有批量删除题目功能
- ✅ 已有批量更新题目功能（`AdminQuestions.tsx`）
- ❌ 可能缺少批量导入学生、批量发布试卷等功能

#### 建议检查
1. 检查批量操作是否完整
2. 添加批量发布试卷功能
3. 优化批量操作性能

---

### 11. **角色权限细化管理** ⚠️ 基础实现

#### 当前状态
- ✅ 有基础角色（admin/teacher/student/parent）
- ❌ 缺少更细化的权限控制（如：老师A只能管理自己创建的试卷）

#### 建议实现
1. 实现更细化的权限控制
2. 添加权限配置界面
3. 支持自定义角色权限

---

## 📋 技术债务

### 1. **数据库 Schema**
- ✅ 表结构基本完整
- ⚠️ 缺少学校/年级配置表
- ⚠️ 需要优化索引和 RLS 策略

### 2. **RLS 策略**
- ⚠️ 部分表未启用 RLS
- ⚠️ RLS 策略性能需要优化
- ⚠️ 多个宽松策略需要合并

### 3. **错误处理**
- ⚠️ 需要统一错误处理机制
- ⚠️ 需要添加错误日志

### 4. **代码注释**
- ⚠️ 部分复杂逻辑需要添加注释

### 5. **测试**
- ❌ 缺少单元测试
- ❌ 缺少集成测试

---

## 🎯 建议优先级排序

根据"从架构层面考虑，简洁实用"的原则，建议按以下顺序完善：

### 第一阶段（必须修复）
1. **数据库安全性修复** - 启用 RLS、修复函数安全性
2. **数据库性能优化** - 添加索引、优化 RLS 策略
3. **学校与年级配置管理** - 创建配置表和界面

### 第二阶段（重要功能）
4. **试卷时间限制 UI 优化** - 提升用户体验
5. **移动端适配与 Capacitor 打包** - 如需移动端支持
6. **数据备份功能** - 数据安全

### 第三阶段（增强功能）
7. **试卷模板功能**
8. **题目难度自动评估**
9. **学习路径推荐**
10. **批量操作优化**
11. **角色权限细化管理**

---

## 📝 下一步行动

请确认：
1. 哪些功能需要优先实现？
2. 哪些功能可以延后？
3. 是否有其他特定需求？

---

## 🔍 数据库检查详情

### 表结构完整性 ✅
- `profiles` - 用户档案表（3条数据）
- `questions` - 题目表（16条数据）
- `papers` - 试卷表（1条数据）
- `paper_questions` - 试卷题目关联表（10条数据）
- `answers` - 答案表（0条数据）
- `answers_draft` - 答案草稿表（0条数据）
- `wrong_questions` - 错题本表（0条数据）
- `tags` - 标签表（0条数据）
- `notifications` - 通知表（0条数据）
- `parent_child` - 家长孩子关联表（0条数据）

### 缺失的表 ❌
- `schools` - 学校表
- `grades` - 年级表
- `classes` - 班级表

### 安全性问题 ⚠️
- 4个表未启用 RLS
- 4个函数存在安全性问题
- Auth 泄露密码保护未启用

### 性能问题 ⚠️
- 8个外键缺少索引
- 多个 RLS 策略性能问题
- 15个未使用的索引
- 多个宽松策略影响性能

